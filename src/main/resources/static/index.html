<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>devSns GUI</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind custom config (ì„ íƒ)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#4f46e5' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
<!-- Header -->
<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
        <div class="h-8 w-8 rounded-lg bg-brand/10 flex items-center justify-center text-brand font-bold">SNS</div>
        <h1 class="text-xl font-semibold">devSns</h1>
        <div class="ml-auto">
            <button id="refresh-feed" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- New Post -->
    <section class="bg-white rounded-2xl border border-slate-200 shadow-sm">
        <div class="p-4 md:p-6">
            <h2 class="text-lg font-semibold mb-3">ìƒˆ í¬ìŠ¤íŠ¸</h2>
            <div class="grid md:grid-cols-5 gap-3">
                <input id="new-post-user" class="md:col-span-1 w-full border border-slate-300 rounded-xl px-3 py-2" placeholder="user_name" />
                <textarea id="new-post-content" class="md:col-span-3 w-full border border-slate-300 rounded-xl px-3 py-2" rows="2" placeholder="ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”?"></textarea>
                <button id="btn-create-post" class="md:col-span-1 w-full bg-brand text-white rounded-xl px-4 py-2 hover:bg-indigo-600">í¬ìŠ¤íŠ¸</button>
            </div>
            <p id="post-create-msg" class="text-sm text-slate-500 mt-2"></p>
        </div>
    </section>

    <!-- Feed -->
    <section class="bg-white rounded-2xl border border-slate-200 shadow-sm">
        <div class="p-4 md:p-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold">í”¼ë“œ</h2>
                <div class="text-xs text-slate-500">* ìµœì‹  15ê°œì”© ë¡œë“œ, ë¬´í•œ ìŠ¤í¬ë¡¤/ë”ë³´ê¸°</div>
            </div>
            <div id="feed" class="space-y-4"></div>
            <div id="feed-empty" class="hidden text-sm text-slate-500 text-center py-6">ì•„ì§ í¬ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”.</div>
            <div class="mt-4 flex justify-center">
                <button id="btn-load-more" class="hidden px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100">ë” ë³´ê¸°</button>
            </div>
        </div>
    </section>
</main>

<!-- Post Detail / Comments Drawer -->
<div id="drawer" class="fixed inset-0 z-30 hidden">
    <div class="absolute inset-0 bg-black/30" id="drawer-backdrop"></div>
    <aside class="absolute right-0 top-0 h-full w-full md:w-[560px] bg-white shadow-xl p-4 md:p-6 overflow-y-auto">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">í¬ìŠ¤íŠ¸</h3>
            <button id="drawer-close" class="rounded-lg px-3 py-1.5 border border-slate-300 hover:bg-slate-100">ë‹«ê¸°</button>
        </div>
        <article id="drawer-post" class="mt-4"></article>

        <hr class="my-4">

        <section>
            <h4 class="font-semibold mb-2">ëŒ“ê¸€</h4>
            <div id="comments" class="space-y-3"></div>
            <div id="comments-empty" class="hidden text-sm text-slate-500 py-3">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            <div class="mt-3 flex justify-center">
                <button id="btn-comments-more" class="hidden px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100 text-sm">ëŒ“ê¸€ ë” ë³´ê¸°</button>
            </div>
        </section>

        <section class="mt-6">
            <h4 class="font-semibold mb-2">ëŒ“ê¸€ ì“°ê¸°</h4>
            <div class="grid grid-cols-5 gap-2">
                <input id="new-comment-user" class="col-span-2 border border-slate-300 rounded-xl px-3 py-2" placeholder="user_name" />
                <input id="new-comment-content" class="col-span-3 border border-slate-300 rounded-xl px-3 py-2" placeholder="ëŒ“ê¸€ ë‚´ìš©" />
            </div>
            <div class="mt-2 flex justify-end">
                <button id="btn-create-comment" class="bg-slate-900 text-white px-4 py-2 rounded-xl hover:bg-slate-800">ë“±ë¡</button>
            </div>
            <p id="comment-create-msg" class="text-sm text-slate-500 mt-2"></p>
        </section>
    </aside>
</div>

<!-- Toast -->
<div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-50 hidden">
    <div class="bg-slate-900 text-white px-4 py-2 rounded-xl shadow-lg text-sm" id="toast-msg"></div>
</div>

<script>
    // ---------- Config ----------
    const API_BASE = ''; // ë™ì¼ ì˜¤ë¦¬ì§„ì´ë©´ ë¹ˆ ê°’, í”„ë¡ì‹œ/ë„ë©”ì¸ì´ ë‹¤ë¥´ë©´ 'http://localhost:8080' ë“±ìœ¼ë¡œ ì§€ì •

    // ---------- Helpers ----------
    function qs(sel) { return document.querySelector(sel); }
    function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }

    function showToast(msg, ms = 1800) {
        const wrap = qs('#toast'), box = qs('#toast-msg');
        box.textContent = msg;
        wrap.classList.remove('hidden', 'opacity-0');
        setTimeout(() => wrap.classList.add('opacity-0'), ms);
        setTimeout(() => wrap.classList.add('hidden'), ms + 200);
    }

    function timeAgo(iso) {
        try {
            const t = new Date(iso);
            const s = (Date.now() - t.getTime())/1000;
            if (s < 60) return `${Math.floor(s)}ì´ˆ ì „`;
            if (s < 3600) return `${Math.floor(s/60)}ë¶„ ì „`;
            if (s < 86400) return `${Math.floor(s/3600)}ì‹œê°„ ì „`;
            return t.toLocaleString();
        } catch { return iso; }
    }

    function apiFetch(path, { method='GET', query, body, headers } = {}) {
        const u = new URL((API_BASE + path), window.location.origin);
        if (query && typeof query === 'object') {
            for (const [k, v] of Object.entries(query)) {
                if (v !== undefined && v !== null && v !== '') u.searchParams.set(k, String(v));
            }
        }
        const init = { method, headers: { 'Content-Type': 'application/json', ...(headers||{}) } };
        if (method !== 'GET' && method !== 'HEAD' && body !== undefined) {
            init.body = typeof body === 'string' ? body : JSON.stringify(body);
        }
        return fetch(u.toString(), init).then(async r => {
            const text = await r.text();
            let json = null; try { json = text ? JSON.parse(text) : null; } catch { json = { raw: text }; }
            if (!r.ok) {
                const msg = (json && json.error_message) || r.statusText || 'Request failed';
                throw new Error(`${r.status} ${msg}`);
            }
            return json;
        });
    }

    // ---------- API wrappers ----------
    function listPosts(beforeId) {
        return apiFetch('/posts', { query: { before: beforeId } });
    }
    function getPost(id) { return apiFetch(`/posts/${id}`); }
    function likePost(id) { return apiFetch(`/posts/${id}/likes`, { method: 'POST' }); }
    function updatePostContent(id, content) { return apiFetch(`/posts/${id}/contents`, { method:'PATCH', body:{ data: content } }); }
    function createPost(content, user_name) { return apiFetch('/posts', { method:'POST', body:{ content, user_name } }); }

    function listComments(postId, beforeId) {
        return apiFetch(`/posts/${postId}/comments`, { query: { before: beforeId } });
    }
    function createComment(post_id, content, user_name) { return apiFetch('/comments', { method:'POST', body:{ post_id, content, user_name } }); }
    function likeComment(id) { return apiFetch(`/comments/${id}/likes`, { method:'POST' }); }
    function updateCommentContent(id, content) { return apiFetch(`/comments/${id}/contents`, { method:'PATCH', body:{ data: content } }); }
    function deleteComment(id) { return apiFetch(`/comments/${id}`, { method:'DELETE' }); }

    // ---------- State ----------
    let feed = [];                 // ëˆ„ì  posts
    let feedNext = null;           // nextQueryCriteria(Long ID)
    let loadingFeed = false;

    let drawerPost = null;         // í˜„ì¬ ì—´ë ¤ìˆëŠ” í¬ìŠ¤íŠ¸ dto
    let comments = [];             // í˜„ì¬ í¬ìŠ¤íŠ¸ì˜ ëŒ“ê¸€ ëˆ„ì 
    let commentsNext = null;       // nextQueryCriteria(Long ID) for comments
    let loadingComments = false;

    // ---------- Render ----------
    function renderFeed() {
        const el = qs('#feed');
        el.innerHTML = '';
        if (!feed.length) {
            qs('#feed-empty').classList.remove('hidden');
            qs('#btn-load-more').classList.add('hidden');
            return;
        }
        qs('#feed-empty').classList.add('hidden');

        for (const p of feed) {
            el.insertAdjacentHTML('beforeend', postCardHTML(p));
        }
        // load more ë²„íŠ¼
        if (feedNext) {
            qs('#btn-load-more').classList.remove('hidden');
        } else {
            qs('#btn-load-more').classList.add('hidden');
        }
        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        qsa('[data-like-post]').forEach(btn => btn.onclick = onLikePost);
        qsa('[data-open-post]').forEach(btn => btn.onclick = onOpenPost);
        qsa('[data-edit-post]').forEach(btn => btn.onclick = onEditPost);
    }

    function postCardHTML(p) {
        // ë°±ì—”ë“œì—ì„œ ë‚´ë ¤ì£¼ëŠ” 'comments'ëŠ” ëŒ“ê¸€ ê°œìˆ˜(Long)
        const commentsCount = p.comments || 0;
        return `
      <article class="border border-slate-200 rounded-2xl p-4 hover:bg-slate-50">
        <header class="flex items-center gap-2">
          <div class="h-8 w-8 rounded-full bg-slate-200"></div>
          <div>
            <div class="text-sm font-semibold">@${escapeHtml(p.user_name)}</div>
            <div class="text-xs text-slate-500">${timeAgo(p.created_at)}</div>
          </div>
          <div class="ml-auto text-xs text-slate-500">#${p.id}</div>
        </header>
        <p class="mt-3 whitespace-pre-wrap break-words">${escapeHtml(p.content)}</p>
        <footer class="mt-3 flex items-center gap-2 text-sm">
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100"
                  data-like-post="${p.id}">ğŸ‘ ì¢‹ì•„ìš” <span class="font-medium">${p.like_count}</span></button>
          <button class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100"
                  data-open-post="${p.id}">ğŸ’¬ ëŒ“ê¸€ <span class="font-medium">${commentsCount}</span></button>
          <button class="ml-auto text-xs text-slate-500 underline decoration-dotted"
                  data-edit-post="${p.id}">ë‚´ìš© ìˆ˜ì •</button>
        </footer>
      </article>`;
    }

    function renderDrawerPost() {
        const wrap = qs('#drawer-post');
        const p = drawerPost;
        if (!p) { wrap.innerHTML = ''; return; }
        wrap.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="h-10 w-10 rounded-full bg-slate-200"></div>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <div class="font-semibold">@${escapeHtml(p.user_name)}</div>
              <div class="text-xs text-slate-500">${timeAgo(p.created_at)} â€¢ #${p.id}</div>
            </div>
            <div class="mt-2 whitespace-pre-wrap break-words">${escapeHtml(p.content)}</div>
            <div class="mt-3 flex items-center gap-2">
              <button class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100"
                      data-like-post="${p.id}">ğŸ‘ ì¢‹ì•„ìš” <span class="font-medium">${p.like_count}</span></button>
              <button class="text-xs text-slate-500 underline decoration-dotted"
                      data-edit-post="${p.id}">ë‚´ìš© ìˆ˜ì •</button>
            </div>
          </div>
        </div>
      `;
        // ì´ë²¤íŠ¸
        qsa('#drawer-post [data-like-post]').forEach(btn => btn.onclick = onLikePost);
        qsa('#drawer-post [data-edit-post]').forEach(btn => btn.onclick = onEditPost);
    }

    function renderComments() {
        const list = qs('#comments');
        list.innerHTML = '';
        if (!comments.length) {
            qs('#comments-empty').classList.remove('hidden');
            qs('#btn-comments-more').classList.add('hidden');
            return;
        }
        qs('#comments-empty').classList.add('hidden');

        for (const c of comments) {
            list.insertAdjacentHTML('beforeend', commentItemHTML(c));
        }
        if (commentsNext) {
            qs('#btn-comments-more').classList.remove('hidden');
        } else {
            qs('#btn-comments-more').classList.add('hidden');
        }
        // ì´ë²¤íŠ¸
        qsa('[data-like-comment]').forEach(btn => btn.onclick = onLikeComment);
        qsa('[data-del-comment]').forEach(btn => btn.onclick = onDeleteComment);
        qsa('[data-edit-comment]').forEach(btn => btn.onclick = onEditComment);
    }

    function commentItemHTML(c) {
        return `
      <div class="border border-slate-200 rounded-xl p-3">
        <div class="flex items-center gap-2">
          <div class="h-6 w-6 rounded-full bg-slate-200"></div>
          <div class="text-sm font-semibold">@${escapeHtml(c.user_name)}</div>
          <div class="ml-auto text-xs text-slate-500">${timeAgo(c.created_at)} â€¢ #${c.id}</div>
        </div>
        <div class="mt-2 text-sm whitespace-pre-wrap break-words">${escapeHtml(c.content)}</div>
        <div class="mt-2 flex items-center gap-2 text-sm">
          <button class="px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100"
                  data-like-comment="${c.id}">ğŸ‘ <span class="font-medium">${c.like_count}</span></button>
          <button class="text-xs text-slate-500 underline decoration-dotted" data-edit-comment="${c.id}">ìˆ˜ì •</button>
          <button class="text-xs text-rose-600 underline decoration-dotted" data-del-comment="${c.id}">ì‚­ì œ</button>
        </div>
      </div>`;
    }

    function escapeHtml(s) {
        return String(s ?? '')
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'","&#39;");
    }

    // ---------- Event Handlers ----------
    async function loadFeed(initial=false) {
        if (loadingFeed) return;
        loadingFeed = true;
        try {
            const before = initial ? null : feedNext;
            const res = await listPosts(before);
            const items = res?.data ?? [];
            if (initial) feed = items;
            else feed = feed.concat(items);
            feedNext = res?.nextQueryCriteria ?? null;
            renderFeed();
        } catch (e) {
            showToast(`í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
        } finally {
            loadingFeed = false;
        }
    }

    async function onLikePost(e) {
        const id = Number(e.currentTarget.getAttribute('data-like-post'));
        try {
            await likePost(id); // 204 No Content, no body
            const updated = await getPost(id); // ìµœì‹  ë°ì´í„° ë‹¤ì‹œ fetch
            // feed/ drawer ìƒíƒœ ë™ê¸°í™”
            feed = feed.map(p => p.id === id ? updated : p);
            if (drawerPost && drawerPost.id === id) drawerPost = updated;
            renderFeed();
            if (!qs('#drawer').classList.contains('hidden')) renderDrawerPost();
        } catch (e) { showToast(`ì¢‹ì•„ìš” ì‹¤íŒ¨: ${e.message}`); }
    }

    async function onOpenPost(e) {
        const id = Number(e.currentTarget.getAttribute('data-open-post'));
        try {
            const p = await getPost(id);
            drawerPost = p;
            renderDrawerPost();
            openDrawer();

            // ëŒ“ê¸€ ëª©ë¡ì„ ë³„ë„ë¡œ ë¡œë“œ
            await loadComments(true);
        } catch (e) { showToast(`í¬ìŠ¤íŠ¸ ì—´ê¸° ì‹¤íŒ¨: ${e.message}`); }
    }

    async function loadComments(initial=false) {
        if (loadingComments || !drawerPost) return;
        loadingComments = true;
        try {
            const before = initial ? null : commentsNext;
            const res = await listComments(drawerPost.id, before);
            const items = res?.data ?? [];

            if (initial) comments = items;
            else comments = comments.concat(items);

            commentsNext = res?.nextQueryCriteria ?? null;
            renderComments();
        } catch (e) {
            showToast(`ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
        } finally {
            loadingComments = false;
        }
    }

    async function onEditPost(e) {
        const id = Number(e.currentTarget.getAttribute('data-edit-post'));
        const current = (feed.find(p => p.id === id) || drawerPost || {});
        const content = prompt('ìƒˆ ë‚´ìš© ì…ë ¥', current.content || '');
        if (!content) return;
        try {
            const updated = await updatePostContent(id, content);
            feed = feed.map(p => p.id === id ? updated : p);
            if (drawerPost && drawerPost.id === id) drawerPost = updated;
            renderFeed();
            if (!qs('#drawer').classList.contains('hidden')) renderDrawerPost();
            showToast('ìˆ˜ì • ì™„ë£Œ');
        } catch (e) { showToast(`ìˆ˜ì • ì‹¤íŒ¨: ${e.message}`); }
    }

    async function onLikeComment(e) {
        const id = Number(e.currentTarget.getAttribute('data-like-comment'));
        try {
            await likeComment(id); // 204 No Content
            // ëŒ“ê¸€ ëª©ë¡ì€ Drawerê°€ ì—´ë ¤ìˆì„ë•Œë§Œ ê°±ì‹ í•˜ë©´ ë˜ë¯€ë¡œ,
            // ê°„ë‹¨í•˜ê²Œ í•´ë‹¹ ëŒ“ê¸€ì˜ like_countë§Œ 1 ì¦ê°€ì‹œì¼œì„œ ë Œë”ë§.
            const targetComment = comments.find(c => c.id === id);
            if(targetComment) {
                targetComment.like_count += 1;
                renderComments();
            }
        } catch (e) { showToast(`ëŒ“ê¸€ ì¢‹ì•„ìš” ì‹¤íŒ¨: ${e.message}`); }
    }

    async function onDeleteComment(e) {
        const id = Number(e.currentTarget.getAttribute('data-del-comment'));
        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
        try {
            await deleteComment(id);
            comments = comments.filter(c => c.id !== id);
            renderComments();
            // ëŒ“ê¸€ ìˆ˜ ê°±ì‹ ì„ ìœ„í•´ í¬ìŠ¤íŠ¸ ì¬ì¡°íšŒ
            if(drawerPost) {
                const updatedPost = await getPost(drawerPost.id);
                drawerPost = updatedPost;
                feed = feed.map(p => p.id === drawerPost.id ? updatedPost : p);
                renderFeed();
            }
            showToast('ì‚­ì œ ì™„ë£Œ');
        } catch (e) { showToast(`ì‚­ì œ ì‹¤íŒ¨: ${e.message}`); }
    }

    async function onEditComment(e) {
        const id = Number(e.currentTarget.getAttribute('data-edit-comment'));
        const curr = comments.find(c => c.id === id);
        const content = prompt('ìƒˆ ëŒ“ê¸€ ë‚´ìš©', curr?.content || '');
        if (!content) return;
        try {
            const updated = await updateCommentContent(id, content);
            comments = comments.map(c => c.id === id ? updated : c);
            renderComments();
            showToast('ìˆ˜ì • ì™„ë£Œ');
        } catch (e) { showToast(`ìˆ˜ì • ì‹¤íŒ¨: ${e.message}`); }
    }

    // Drawer control
    function openDrawer() { qs('#drawer').classList.remove('hidden'); }
    function closeDrawer() {
        qs('#drawer').classList.add('hidden');
        drawerPost = null;
        comments = [];
        commentsNext = null;
    }

    // ---------- Listeners ----------
    qs('#refresh-feed').onclick = () => loadFeed(true);
    qs('#btn-load-more').onclick = () => loadFeed(false);

    // ìƒˆ í¬ìŠ¤íŠ¸
    qs('#btn-create-post').onclick = async () => {
        const content = qs('#new-post-content').value.trim();
        const user = qs('#new-post-user').value.trim();
        if (!content || !user) { showToast('content / user_nameì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
        qs('#post-create-msg').textContent = 'ìƒì„± ì¤‘...';
        try {
            const res = await createPost(content, user);
            qs('#post-create-msg').textContent = `ìƒì„±ë¨: id=${res?.data}`;
            qs('#new-post-content').value = '';
            // ìƒˆë¡œê³ ì¹¨
            await loadFeed(true);
        } catch (e) {
            qs('#post-create-msg').textContent = `ì‹¤íŒ¨: ${e.message}`;
        }
    };

    // Drawer buttons
    qs('#drawer-close').onclick = closeDrawer;
    qs('#drawer-backdrop').onclick = closeDrawer;

    // ëŒ“ê¸€: ë” ë³´ê¸°
    qs('#btn-comments-more').onclick = () => loadComments(false);

    // ëŒ“ê¸€: ì‘ì„±
    qs('#btn-create-comment').onclick = async () => {
        if (!drawerPost) return;
        const user = qs('#new-comment-user').value.trim();
        const content = qs('#new-comment-content').value.trim();
        if (!user || !content) { showToast('user_name / contentë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
        qs('#comment-create-msg').textContent = 'ë“±ë¡ ì¤‘...';
        try {
            await createComment(drawerPost.id, content, user);
            qs('#comment-create-msg').textContent = 'ë“±ë¡ ì™„ë£Œ';
            qs('#new-comment-content').value = '';

            // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadComments(true);

            // ëŒ“ê¸€ ìˆ˜ ê°±ì‹ ì„ ìœ„í•´ í¬ìŠ¤íŠ¸ ì¬ì¡°íšŒ
            const updatedPost = await getPost(drawerPost.id);
            drawerPost = updatedPost;
            feed = feed.map(p => p.id === drawerPost.id ? updatedPost : p);
            renderFeed();
            renderDrawerPost();

        } catch (e) {
            qs('#comment-create-msg').textContent = `ì‹¤íŒ¨: ${e.message}`;
        }
    };

    // ---------- Init ----------
    loadFeed(true);
    // Infinite scroll (í•˜ë‹¨ 200pxì—ì„œ ë”ë³´ê¸°)
    window.addEventListener('scroll', () => {
        const nearBottom = window.innerHeight + window.scrollY > document.body.offsetHeight - 200;
        if (nearBottom && feedNext && !loadingFeed) loadFeed(false);
    });
</script>
</body>
</html>