<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- ì œëª© / ë‚´ìš© -->
    <h2 th:text="${post.title}">ì œëª©</h2>
    <h2 th:text="${post.content}">ë‚´ìš©</h2>
    <p>
        <b>ì‘ì„±ì:</b>
        <span th:text="${post.author}"></span>
    </p>

    <!-- ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ -->
    <a th:href="@{|/posts/${post.id}/edit|}">
        <button type="button">ìˆ˜ì •</button>
    </a>
    <form th:action="@{|/posts/${post.id}/delete|}" method="post">
        <button type="submit">ì‚­ì œ</button>
    </form>
    <a th:href="@{|/posts|}">
        <button type="button">ê²Œì‹œê¸€ ë³´ê¸°</button>
    </a>

    <!-- ì¢‹ì•„ìš” -->
    <hr/>

    <div>
        <button id="like-btn"
                th:data-post-id="${post.id}"
                th:data-member-id="${memberId}"
                th:classappend="${liked} ? ' liked' : ''"
                style="border:none; background:none; cursor:pointer; font-size:18px;">
            <span id="like-icon" th:text="${liked} ? 'â¤ï¸' : 'ğŸ¤'"></span>
            <span id="like-count" th:text="${likeCount}"></span>
        </button>
    </div>

    <hr/>

    <!-- ëŒ“ê¸€ -->
    <hr />
    <h3>ëŒ“ê¸€</h3>

    <div th:if="${#lists.isEmpty(post.comments)}">
        <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <ul th:if="${!#lists.isEmpty(post.comments)}">
        <li th:each="comment : ${post.comments}">
            <p><b th:text="${comment.username}"></b></p>
            <p th:text="${comment.content}"></p>
            <p>ì‘ì„±ì¼:
                <small th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
            </p>

            <form th:action="@{'/comments/' + ${comment.id} + '/delete'}" method="post">
                <input type="hidden" name="postId" th:value="${post.id}">
                <button type="submit">ëŒ“ê¸€ ì‚­ì œ</button>
            </form>

            <hr/>
        </li>
    </ul>

    <hr />

    <!-- ëŒ“ê¸€ ì‘ì„± -->
    <h3>ëŒ“ê¸€ ì‘ì„±í•˜ê¸°</h3>

    <form th:action="@{'/comments/' + ${post.id}}" method="post">
        <p>
            ì‘ì„±ì:
            <input type="text" name="username" required />
        </p>
        <p>
            ë‚´ìš©:<br/>
            <textarea name="content" rows="4" cols="50" required></textarea>
        </p>

        <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
    </form>

    <!-- ì¢‹ì•„ìš” Ajax ìŠ¤í¬ëŸ½íŠ¸ -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const btn = document.getElementById("like-btn");

            btn.addEventListener("click", async function () {
                const postId = btn.dataset.postId;
                const memberId = btn.dataset.memberId;

                const likedNow = btn.classList.contains("liked");
                const method = likedNow ? "DELETE" : "POST";

                const res = await fetch(`/posts/${postId}/like?memberId=${memberId}`, {
                    method: method
                });

                const data = await res.json();

                // UI ì—…ë°ì´íŠ¸(ì¢‹ì•„ìš” ìˆ˜)
                document.getElementById("like-count").textContent = data.likeCount;

                // UI ì—…ë°ì´íŠ¸(í•˜íŠ¸ ì•„ì´ì½˜)
                if (data.liked) {
                    btn.classList.add("liked");
                    document.getElementById("like-icon").textContent = "â¤ï¸";
                } else {
                    btn.classList.remove("liked");
                    document.getElementById("like-icon").textContent = "ğŸ¤";
                }
            });
        });
    </script>

</body>
</html>